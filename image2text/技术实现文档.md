# image2text MCP 技术实现文档

## 1. 项目架构设计

### 1.1 整体架构
```
image2text_mcp/
├── src/
│   ├── __init__.py
│   ├── main.py              # MCP服务器主入口
│   ├── config.py            # 配置管理
│   ├── image_processor.py   # 图片处理核心逻辑
│   ├── api_client.py        # API客户端封装
│   └── utils.py             # 工具函数
├── tests/
│   ├── __init__.py
│   ├── test_image_processor.py
│   ├── test_api_client.py
│   └── test_config.py
├── requirements.txt
├── pyproject.toml
└── README.md
```

### 1.2 技术栈
- **框架**: FastMCP (Python MCP SDK)
- **传输协议**: HTTP with SSE streaming
- **端口**: 8201
- **API协议**: OpenAI兼容协议
- **依赖库**:
  - mcp[cli] >= 0.1.0
  - fastapi >= 0.104.0
  - uvicorn >= 0.24.0
  - httpx >= 0.25.0
  - pydantic >= 2.0.0

## 2. 核心模块设计

### 2.1 MCP服务器模块 (main.py)

```python
"""
MCP服务器主模块
负责初始化FastMCP服务器并注册图片处理工具
"""

from mcp.server.fastmcp import FastMCP
from src.config import Config
from src.image_processor import ImageProcessor

# 初始化FastMCP服务器
mcp = FastMCP(
    name="image2text",
    json_response=False,      # 使用SSE流式响应
    stateless_http=False      # 保持连接状态
)

@mcp.tool()
async def extract_text_from_image(
    image_data: str,
    api_base_url: str = None,
    api_key: str = None,
    model_id: str = None
) -> str:
    """
    从图片中提取文本内容

    Args:
        image_data: 图片的base64编码数据
        api_base_url: API基础地址（可选，通过header传递）
        api_key: API密钥（可选，通过header传递）
        model_id: 模型ID（可选，通过header传递）

    Returns:
        提取的文本内容
    """
    processor = ImageProcessor(
        base_url=api_base_url or Config.DEFAULT_API_BASE,
        api_key=api_key or Config.DEFAULT_API_KEY,
        model_id=model_id or Config.DEFAULT_MODEL_ID
    )

    try:
        result = await processor.extract_text(image_data)
        return result
    except Exception as e:
        return f"图片文本提取失败: {str(e)}"

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description="image2text MCP服务器")
    parser.add_argument("--port", type=int, default=8201, help="监听端口")
    args = parser.parse_args()

    # 启动HTTP服务器
    uvicorn.run(mcp.streamable_http_app, host="0.0.0.0", port=args.port)
```

### 2.2 配置管理模块 (config.py)

```python
"""
配置管理模块
处理API配置和环境变量
"""

import os
from typing import Optional
from pydantic import BaseSettings

class Config(BaseSettings):
    """配置类，支持环境变量和默认值"""

    # API配置
    DEFAULT_API_BASE: str = "https://api.openai.com/v1"
    DEFAULT_API_KEY: Optional[str] = None
    DEFAULT_MODEL_ID: str = "gpt-4-vision-preview"

    # 服务器配置
    SERVER_PORT: int = 8201
    SERVER_HOST: str = "0.0.0.0"

    # 图片处理配置
    MAX_IMAGE_SIZE: int = 10 * 1024 * 1024  # 10MB
    SUPPORTED_FORMATS: list = ["image/jpeg", "image/png", "image/webp"]

    class Config:
        env_file = ".env"
        case_sensitive = True

# 全局配置实例
config = Config()
```

### 2.3 API客户端模块 (api_client.py)

```python
"""
API客户端模块
封装OpenAI兼容API调用
"""

import httpx
import base64
from typing import Dict, Any, Optional
from src.config import config

class APIClient:
    """OpenAI兼容API客户端"""

    def __init__(self, base_url: str, api_key: str, model_id: str):
        self.base_url = base_url.rstrip("/")
        self.api_key = api_key
        self.model_id = model_id
        self.client = httpx.AsyncClient(
            timeout=30.0,
            headers={
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json"
            }
        )

    async def vision_completion(self, image_data: str, prompt: str = "描述这张图片的内容") -> str:
        """
        调用视觉模型API进行图片理解

        Args:
            image_data: base64编码的图片数据
            prompt: 提示词

        Returns:
            模型返回的文本内容
        """
        payload = {
            "model": self.model_id,
            "messages": [
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{image_data}"
                            }
                        }
                    ]
                }
            ],
            "max_tokens": 500
        }

        try:
            response = await self.client.post(
                f"{self.base_url}/chat/completions",
                json=payload
            )
            response.raise_for_status()

            result = response.json()
            return result["choices"][0]["message"]["content"]

        except httpx.HTTPError as e:
            raise Exception(f"API调用失败: {str(e)}")
        finally:
            await self.client.aclose()
```

### 2.4 图片处理模块 (image_processor.py)

```python
"""
图片处理核心模块
负责图片验证、格式转换和文本提取
"""

import base64
import imghdr
from typing import Optional
from src.api_client import APIClient
from src.config import config

class ImageProcessor:
    """图片处理器"""

    def __init__(self, base_url: str, api_key: str, model_id: str):
        self.api_client = APIClient(base_url, api_key, model_id)

    async def extract_text(self, image_data: str, prompt: Optional[str] = None) -> str:
        """
        从图片中提取文本内容

        Args:
            image_data: base64编码的图片数据
            prompt: 可选的提示词

        Returns:
            提取的文本内容
        """
        # 验证图片格式
        if not self._validate_image(image_data):
            raise ValueError("不支持的图片格式或图片数据无效")

        # 检查图片大小
        image_size = len(base64.b64decode(image_data))
        if image_size > config.MAX_IMAGE_SIZE:
            raise ValueError(f"图片大小超过限制: {image_size} > {config.MAX_IMAGE_SIZE}")

        # 调用API进行文本提取
        prompt = prompt or "请详细描述这张图片的内容，包括文字和视觉元素"
        result = await self.api_client.vision_completion(image_data, prompt)

        return result.strip()

    def _validate_image(self, image_data: str) -> bool:
        """
        验证图片数据的有效性

        Args:
            image_data: base64编码的图片数据

        Returns:
            是否有效
        """
        try:
            # 解码base64数据
            image_bytes = base64.b64decode(image_data)

            # 检测图片格式
            image_type = imghdr.what(None, image_bytes)

            # 检查支持的格式
            mime_type = f"image/{image_type}" if image_type else ""
            return mime_type in config.SUPPORTED_FORMATS

        except Exception:
            return False
```

## 3. 测试策略

### 3.1 单元测试示例 (test_image_processor.py)

```python
"""
图片处理器单元测试
"""

import pytest
import base64
from unittest.mock import AsyncMock, patch
from src.image_processor import ImageProcessor

class TestImageProcessor:

    @pytest.fixture
    def sample_image_data(self):
        # 创建一个小的测试图片数据
        with open("tests/fixtures/test_image.jpg", "rb") as f:
            return base64.b64encode(f.read()).decode()

    @pytest.fixture
    def processor(self):
        return ImageProcessor(
            base_url="https://test.api.com",
            api_key="test_key",
            model_id="test_model"
        )

    @pytest.mark.asyncio
    async def test_extract_text_success(self, processor, sample_image_data):
        """测试成功的文本提取"""

        # Mock API客户端
        with patch.object(processor.api_client, 'vision_completion', new_callable=AsyncMock) as mock_api:
            mock_api.return_value = "这是一张测试图片"

            result = await processor.extract_text(sample_image_data)

            assert result == "这是一张测试图片"
            mock_api.assert_called_once()

    def test_validate_image_valid(self, processor, sample_image_data):
        """测试有效的图片格式验证"""

        is_valid = processor._validate_image(sample_image_data)
        assert is_valid is True

    def test_validate_image_invalid(self, processor):
        """测试无效的图片格式验证"""

        invalid_data = "invalid_base64_data"
        is_valid = processor._validate_image(invalid_data)
        assert is_valid is False
```

## 4. 部署和运行

### 4.1 环境准备
```bash
# 激活虚拟环境
source .venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 设置环境变量（可选）
export DEFAULT_API_KEY="your_api_key"
export DEFAULT_API_BASE="https://your.api.endpoint"
```

### 4.2 启动服务器
```bash
# 默认端口8201
python src/main.py

# 自定义端口
python src/main.py --port 8080
```

### 4.3 测试调用
```bash
# 使用curl测试MCP端点
curl -X POST http://localhost:8201/mcp \
  -H "Content-Type: application/json" \
  -H "X-API-Base: https://your.api.endpoint" \
  -H "X-API-Key: your_api_key" \
  -H "X-Model-ID: your_model_id" \
  -d '{
    "tool": "extract_text_from_image",
    "arguments": {
      "image_data": "base64_encoded_image_data"
    }
  }'
```

## 5. 错误处理

### 5.1 常见错误码
- `400`: 图片格式不支持或数据无效
- `413`: 图片大小超过限制
- `401`: API密钥无效
- `429`: API调用频率限制
- `500`: 服务器内部错误

### 5.2 错误处理策略
```python
try:
    result = await processor.extract_text(image_data)
except ValueError as e:
    # 客户端错误（400系列）
    return f"请求错误: {str(e)}"
except httpx.HTTPError as e:
    # API调用错误
    if e.response.status_code == 401:
        return "API密钥无效"
    elif e.response.status_code == 429:
        return "API调用频率超限，请稍后重试"
    else:
        return f"API调用失败: {str(e)}"
except Exception as e:
    # 其他错误
    return f"处理失败: {str(e)}"
```

## 6. 性能优化

### 6.1 缓存策略
- 对相同图片的重复请求进行缓存
- 使用LRU缓存机制，限制缓存大小
- 缓存TTL设置为1小时

### 6.2 并发处理
- 使用asyncio处理并发请求
- 限制最大并发数，防止API过载
- 实现请求队列和重试机制

### 6.3 监控和日志
- 记录API调用次数和响应时间
- 监控错误率和性能指标
- 实现健康检查端点

这份技术实现文档提供了完整的架构设计、核心模块实现、测试策略和部署方案，可以作为项目开发的详细指导。