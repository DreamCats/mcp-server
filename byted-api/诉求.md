# byted-api mcp工具

## 前置信息

### mcp 相关信息

- 概念：https://modelcontextprotocol.io/docs/getting-started/intro
- 基于 python sdk：https://github.com/modelcontextprotocol/python-sdk
- 基于 python http 协议例子：

```python
"""Weather tools for MCP Streamable HTTP server using NWS API."""

import argparse
from typing import Any

import httpx
import uvicorn

from mcp.server.fastmcp import FastMCP


# Initialize FastMCP server for Weather tools.
# If json_response is set to True, the server will use JSON responses instead of SSE streams
# If stateless_http is set to True, the server uses true stateless mode (new transport per request)
mcp = FastMCP(name="weather", json_response=False, stateless_http=False)

# Constants
NWS_API_BASE = "https://api.weather.gov"
USER_AGENT = "weather-app/1.0"


async def make_nws_request(url: str) -> dict[str, Any] | None:
    """Make a request to the NWS API with proper error handling."""
    headers = {"User-Agent": USER_AGENT, "Accept": "application/geo+json"}
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(url, headers=headers, timeout=30.0)
            response.raise_for_status()
            return response.json()
        except Exception:
            return None


def format_alert(feature: dict) -> str:
    """Format an alert feature into a readable string."""
    props = feature["properties"]
    return f"""
Event: {props.get('event', 'Unknown')}
Area: {props.get('areaDesc', 'Unknown')}
Severity: {props.get('severity', 'Unknown')}
Description: {props.get('description', 'No description available')}
Instructions: {props.get('instruction', 'No specific instructions provided')}
"""


@mcp.tool()
async def get_alerts(state: str) -> str:
    """Get weather alerts for a US state.

    Args:
        state: Two-letter US state code (e.g. CA, NY)
    """
    url = f"{NWS_API_BASE}/alerts/active/area/{state}"
    data = await make_nws_request(url)

    if not data or "features" not in data:
        return "Unable to fetch alerts or no alerts found."

    if not data["features"]:
        return "No active alerts for this state."

    alerts = [format_alert(feature) for feature in data["features"]]
    return "\n---\n".join(alerts)


@mcp.tool()
async def get_forecast(latitude: float, longitude: float) -> str:
    """Get weather forecast for a location.

    Args:
        latitude: Latitude of the location
        longitude: Longitude of the location
    """
    # First get the forecast grid endpoint
    points_url = f"{NWS_API_BASE}/points/{latitude},{longitude}"
    points_data = await make_nws_request(points_url)

    if not points_data:
        return "Unable to fetch forecast data for this location."

    # Get the forecast URL from the points response
    forecast_url = points_data["properties"]["forecast"]
    forecast_data = await make_nws_request(forecast_url)

    if not forecast_data:
        return "Unable to fetch detailed forecast."

    # Format the periods into a readable forecast
    periods = forecast_data["properties"]["periods"]
    forecasts = []
    for period in periods[:5]:  # Only show next 5 periods
        forecast = f"""
{period['name']}:
Temperature: {period['temperature']}°{period['temperatureUnit']}
Wind: {period['windSpeed']} {period['windDirection']}
Forecast: {period['detailedForecast']}
"""
        forecasts.append(forecast)

    return "\n---\n".join(forecasts)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Run MCP Streamable HTTP based server")
    parser.add_argument("--port", type=int, default=8123, help="Localhost port to listen on")
    args = parser.parse_args()

    # Start the server with Streamable HTTP transport
    uvicorn.run(mcp.streamable_http_app, host="localhost", port=args.port)
```

### 获取 jwt 密钥接口

- url：https://cloud.bytedance.net/auth/api/v1/jwt
- headers：
  - "User-Agent"："Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/"
  - "Accept"："application/json, text/plain, */*"
  - "Accept-Language":"zh-CN,zh;q=0.9,en;q=0.8"
  - "Cookie": f"{cookie_key}={cookie_value}"
  - 其中，cookie_key = "CAS_SESSION", cookie_value 则有用户环境变量提供。
- 响应 headers['x-jwt-token']

注意：以上获取 jwt 密钥有三种接口，分站点。

1. cn：https://cloud.bytedance.net/auth/api/v1/jwt
2. i18n：https://cloud-i18n.bytedance.net/auth/api/v1/jwt
3. us：https://cloud-ttp-us.bytedance.net/auth/api/v1/jwt

其中，每个站点的 cookie_value 是不一样的。

目前，环境变量提供了三种变量值：

1. CAS_SESSION_cn="xxx"
2. CAS_SESSION_i18n="xxx"
3. CAS_SESSION_us="xxx"

## 功能诉求

### 获取 psm 信息

> psm 概念：在开发一个服务之前先要确定服务的名字，服务名统一使用PSM进行命名，PSM即为Product, Subsys, Module，如：toutiao.article.item，在这里可以把PSM理解成一个域名，访问对应的PSM就是访问对应的域名。

接口信息：

- url："https://ms-neptune.byted.org/api/neptune/ms/service/search"
- url："https://ms-neptune.tiktok-us.org/api/neptune/ms/service/search"
- header:
  - "x-jwt-token":"xxx"
- param:
  - keyword: "xxx"
  - search_type: "all"

返回信息

```json
{
    "error_code": 0,
    "error_type": "",
    "error_message": "",
    "data": [
        {
            "id": 0,
            "created_at": "0001-01-01T00:00:00Z",
            "updated_at": "0001-01-01T00:00:00Z",
            "psm": "oec.affiliate.monitor",
            "node_id": 9439321,
            "parent_id": 0,
            "type": "thrift",
            "language": "",
            "framework": "kitex",
            "service_chinese_name": "oec.affiliate.monitor",
            "description": "oec.affiliate.monitor",
            "owners": "wangzhonghua.97",
            "git_url": "",
            "idl": "",
            "idl_repo": "",
            "status": "",
            "created_by": "",
            "last_updated_by": "",
            "deployment_platform": "tce",
            "from_ms_data": 0,
            "level": "P2",
            "extend_property": "",
            "framework_version": "",
            "platform_types": {
                "tce": "thrift"
            },
            "path": "",
            "name": "",
            "node_name": "",
            "more": {
                "cost": "",
                "quota": "",
                "subscribed": false
            },
            "source": 0
        }
    ]
}
```

> 注意： 上述是两个请求连接，因为是两个不同区域， 但我希望是并发请求，看返回结果字段psm哪个存在且匹配keyword的值，则取哪个。

### 获取i18n服务集群接口

> 一个 psm 服务对应集群，本接口是通过 psm 返回哪些集群

接口信息：

- url：https://cloud.tiktok-row.net/api/v1/explorer/explorer/v5/plane/clusters
- param
  - psm：xxx
  - test_plane：1
  - env：prod
- header：
  - "accept"："application/json, text/plain, */*"
  - "x-jwt-token"：xxx

返回结果：

```json
{
    "error_code": 0,
    "data": [
        {
            "psm": "oec.affiliate.monitor",
            "cluster": "default",
            "zone": "MVAALI",
            "zone_display_name": "US-East",
            "idc": "maliva",
            "online": true
        },
        {
            "psm": "oec.affiliate.monitor",
            "cluster": "default",
            "zone": "SGALI",
            "zone_display_name": "Singapore-Central",
            "idc": "my",
            "online": true
        },
        {
            "psm": "oec.affiliate.monitor",
            "cluster": "default",
            "zone": "SGALI",
            "zone_display_name": "Singapore-Central",
            "idc": "my2",
            "online": true
        }
    ]
}
```

### 获取i18n集群对应机器实例地址

> 该接口的入参可以通过服务获取集群的接口功能获取

- url：https://cloud.tiktok-row.net/api/v1/explorer/explorer/v5/addrs
- param：
  - psm：xx
  - env：prod
  - zone：xxx
  - idc：xxx
  - cluster：xxx
- headers
  - "accept": "application/json, text/plain, */*"
  - "x-jwt-token"：xxx

返回结果：

```json
{"error_code":0,"data":["[fdbd:dc61:2:151::195]:11503"]}
```

### 模拟i18n rpc 请求功能

> 该功能需要一定的入参

- url： https://cloud.tiktok-row.net/api/v1/explorer/explorer/v5/rpc_request
- method：post
- body：
  - address: "xxxx"，必填
  - cluster: "default"，必填
  - env: "prod"，必填
  - idc: "maliva"，必填
  - zone: "MVAALI"，必填
  - psm: "xxx.xxx.xxx"，服务名称，必填
  - func_name: "SearchLiveEvent"，方法名称，必填
  - idl_source: 1
  - idl_version: "master"
  - online: true
  - rpc_context:[]
  - source:1
  - request_timeout: 60000
  - req_body: "",body json 字符串，必填
  - base: {}

举个例子：

请求参数
```json
{
    "psm": "oec.affiliate.monitor",
    "func_name": "SearchLiveEvent",
    "req_body": "{\n  \"room_id\": \"1730849136927543871\",\n  \"author_id\": \"7280819145410593838\",\n  \"time_selector\": {\n    \"start_timestamp\": 1757831992000,\n    \"end_timestamp\": 1758004792000\n  },\n  \"object_id\": \"1730849136927543871\",\n  \"only_failed_event\": false,\n  \"page\": 0,\n  \"size\": 20,\n  \"Base\": {\n    \"LogID\": \"\",\n    \"Caller\": \"\",\n    \"Addr\": \"\",\n    \"Client\": \"\",\n    \"TrafficEnv\": {\n      \"Open\": false,\n      \"Env\": \"\"\n    },\n    \"Extra\": {\n      \"\": \"\",\n      \"env\": \"prod\"\n    }\n  }\n}",
    "idl_source": 1,
    "idl_version": "master",
    "zone": "MVAALI",
    "idc": "maliva",
    "cluster": "default",
    "env": "prod",
    "address": "[fdbd:dc61:2:151::195]:11503",
    "rpc_context": [],
    "request_timeout": 60000,
    "connect_timeout": 60000,
    "online": true,
    "source": 1,
    "base": {}
}
```

响应参数：

```json
{
    "error_code": 0,
    "error_message": "",
    "data": {
        "help_message": {
            "message": "返回结果来自目标服务 oec.affiliate.monitor，如果返回结果不符合预期, 请联系 oec.affiliate.monitor {owner} 排查。",
            "href": {
                "owner": "https://cloud-i18n.bytedance.net/tce/services?keyword=oec.affiliate.monitor"
            }
        },
        "error": "",
        "resp_body": "{\"live_events\"\n:[{\"room_id\":1730849136927543871,\"author_id\":7280819145410593838,\"event_type\":206,\"update_time\":1757906448294,\"object_ids\":[1730849136927543871],\"operator_id\":\"7280819145410593838\",\"event_description\":\"\\u003cUNSET\\u003e\",\"source\":3,\"log_id\":\"20250915032048B28EE9B21EAA887165DC\",\"status_code\":99,\"status_msg\":\"This LIVE flash sale has been deleted or started before and can't be started again. Please delete this product and create a new flash sale.\",\"id\":7550150302001694477,\"region\":\"US\"}]\n,\"total\"\n:1\n,\"BaseResp\"\n:{\"StatusMessage\":\"success\",\"StatusCode\":0}\n}",
        "request_address": "[fdbd:dc61:2:151::195]:11503",
        "log_id": "2025091808521436FD121A8B72A61489E6",
        "req_latency": "24.013616ms",
        "request_at": 1758185534759,
        "finish_at": 1758185534783,
        "protocol": "thrift",
        "history_id": 253067043,
        "idl_source": 1,
        "idl_version": "master",
        "zone": "MVAALI",
        "idc": "maliva",
        "cluster": "default",
        "env": "prod",
        "address": "[fdbd:dc61:2:151::195]:11503",
        "func_name": "SearchLiveEvent",
        "rpc_context": [],
        "req_body": "{\n  \"room_id\": \"1730849136927543871\",\n  \"author_id\": \"7280819145410593838\",\n  \"time_selector\": {\n    \"start_timestamp\": 1757831992000,\n    \"end_timestamp\": 1758004792000\n  },\n  \"object_id\": \"1730849136927543871\",\n  \"only_failed_event\": false,\n  \"page\": 0,\n  \"size\": 20,\n  \"Base\": {\n    \"LogID\": \"\",\n    \"Caller\": \"\",\n    \"Addr\": \"\",\n    \"Client\": \"\",\n    \"TrafficEnv\": {\n      \"Open\": false,\n      \"Env\": \"\"\n    },\n    \"Extra\": {\n      \"\": \"\",\n      \"env\": \"prod\"\n    }\n  }\n}",
        "request_timeout": 60000,
        "online": true,
        "psm": "oec.affiliate.monitor",
        "argos_link": "https://cloud-i18n.bytedance.net/argos/streamlog/info_overview/log_id_search?psm=oec.affiliate.monitor\u0026region=US-East\u0026logId=2025091808521436FD121A8B72A61489E6",
        "is_masked": false,
        "biz_status_code": 0,
        "debug_info": {
            "tce_info": {
                "pod_name": "dp-28906f1467-5d7b587758-r2kjz",
                "webshell_link": "https://bytepaas-tce-i18n-online.tiktok-row.org/open-apis/v1/web_shell/?_sdk_disabled=1\u0026pod_name=dp-28906f1467-5d7b587758-r2kjz\u0026container_id=containerd://139c67ec9ac83a3e3667c8b1558c213d4c2d625af05635a3bac1b83234a00611\u0026zone=Aliyun_VA\u0026physical_cluster=Loki\u0026idc=Aliyun_VA\u0026provider_type=K8S\u0026ns=default\u0026l=zh-cn\u0026cluster_id=5259672\u0026handle_otp=false\u0026from_type=cloud\u0026control_platform=i18n"
            },
            "argos_info": {
                "local_file_log_link": ""
            },
            "bits_info": {
                "code_line_pass_report_link": ""
            }
        },
        "test_plane": 1,
        "request_base": {}
    },
    "has_permission": true,
    "escape_params": null,
    "permission_link": ""
}
```

响应具体数据在上述例子resp_body字段。

### 通过 logid 获取 us-ttp 服务log 功能

> 该功能是通logid获取具体的服务日志

- url：https://logservice-tx.tiktok-us.org/streamlog/platform/microservice/v1/query/trace
- method：post
- body：
  - logid：xxxx
  - psm_list: ["xxx.xxx.xxx"]
  - scan_scan_in_min:10
  - vregion: "US-TTP,US-TTP2"
- headers
  - "accept": "application/json, text/plain, */*"
  - "x-jwt-token": xxx

响应结果：

```json
{
    "error_code": 0,
    "error_type": "",
    "error_message": "",
    "data": {
        "meta": {
            "scan_time_range": [
                {
                    "start": 1758599143,
                    "end": 1758599743
                },
                {
                    "start": 1758570343,
                    "end": 1758570943
                }
            ],
            "level_list": [
                "Info"
            ],
            "expired_time": 0
        },
        "items": [
            {
                "id": "7a1cb2e413897519e8686092e61089df",
                "group": {
                    "psm": "oec.live.promotion_core",
                    "pod_name": "dp-f0d440257e-7cbb66b855-bczhb",
                    "ipv4": "10.114.57.146",
                    "ipv6": "0:0:0:0:0:0:0:0",
                    "start_time": 1758599203221000,
                    "env": "ppe",
                    "vregion": "US-TTP",
                    "idc": "useast5"
                },
                "value": [
                    {
                        "level": "Info",
                        "id": "8550068586482844256",
                        "kv_list": [
                            {
                                "key": "_level",
                                "type": "STRING",
                                "biz_type": "",
                                "value": "Info",
                                "highlight": true,
                                "display_key_in_string": false,
                                "is_empty": false
                            },
                            {
                                "key": "_msg",
                                "type": "STRING",
                                "biz_type": "",
                                "value": "{{callOriginInfo=oec_promotion_seller_data.go:77}} RPC Call {{PSM=oec.promotion.seller_data}} {{method=MCreateCreatorActivity}} {{rip=10.114.182.82:10736}} info: req={{req=[[{\"main_activity_id_to_activity_info\":{\".*\":[{\"base_info\":{\"promotion_name\":\"Live Flash .*:.*:.*\",\"create_time\":1758599203,\"update_time\":1758599203,\"creation_data_source\":10,\"status\":6},\"activity_time\":{\"promotion_period\":{\"effective_time_type\":4,\"duration\":1200},\"warm_up\":{\"effective_time_type\":4,\"duration\":10}},\"activity_rule\":{\"scope_rule\":[{\"scope_type\":3}]},\"activity_products\":[{\"product_id\":0}]}]},\"common_params\":{\"app_params\":{\"app_id\":1180},\"creator_params\":{\"creator_id\":7280819145410593838,\"region\":\"US\",\"creator_oec_uid\":.*},\"live_params\":{}},\"base\":{\"LogID\":\"20250923034643559E874098ED5808B03C\",\"Caller\":\"oec.live.promotion_core\",\"Addr\":\"10.114.*\",\"Client\":\"\",\"Extra\":{\"byted-trace-id\":\"339077b1fe0548992c4f661600d9c5d3:1f08f6b901d5b35b:20f207b687d033fb:9\",\"cluster\":\"default\",\"env\":\"ppe_feat_live_promotion\",\"idc\":\".*\",\"jaeger-baggage\":\"_sr=.*\",\"stress_tag\":\"\",\"traceparent\":\".*\",\"tracestate\":\"_sr=.*\",\"user_extra\":\"{\\\"RPC_PERSIST_ENCRYPTED_REAL_IP\\\":\\\".*:IP:.*,\\\"RPC_PERSIST_OEC_REGION\\\":\\\"-\\\",\\\"RPC_PERSIST_TTREGION_STORECOUNTRY\\\":\\\"us\\\",\\\"RPC_PERSIST_BYTETIM_SERVICE_SIGN_PSM\\\":\\\"oec.affiliate.streamer_api\\\",\\\"RPC_PERSIST_SERVICE_LEVEL\\\":\\\".*\\\",\\\"RPC_PERSIST_BYTETIM_APP_GROUPID\\\":\\\".*\\\",\\\"RPC_TRANSIT_byted-trace-id\\\":\\\"339077b1fe0548992c4f661600d9c5d3:1f08f6b901d5b35b:20f207b687d033fb:9\\\",\\\"RPC_PERSIST_TTREGION_STORECOUNTRY_SRC\\\":\\\"uid\\\",\\\"RPC_PERSIST_BYTETIM_SERVICE_ITYPE\\\":\\\".*\\\",\\\"RPC_PERSIST_ORI_PATH\\\":\\\"/api/.*/streamer_desktop/live/promotion/create\\\",\\\"RPC_PERSIST_ORI_PSM\\\":\\\"oec.affiliate.streamer_api\\\",\\\"RPC_PERSIST_APP_ID\\\":\\\".*\\\",\\\"RPC_PERSIST_ori_psm\\\":\\\"oec.affiliate.streamer_api\\\",\\\"RPC_PERSIST_BYTETIM_USER_UID\\\":\\\".*\\\",\\\"RPC_PERSIST_BYTETIM_APP_APPID\\\":\\\"253642\\\",\\\"RPC_PERSIST_BYTETIM_META_SIGN\\\":\\\".*\\\",\\\"RPC_PERSIST_REAL_IP_TIMESTAMP\\\":\\\".*\\\",\\\"RPC_PERSIST_LANE_P_AID\\\":\\\".*\\\",\\\"RPC_PERSIST_DEVICE_ID\\\":\\\".*\\\",\\\"RPC_PERSIST_USER_ID\\\":\\\"-\\\",\\\"RPC_TRANSIT_jaeger-baggage\\\":\\\"_sr=.*\\\",\\\"RPC_PERSIST_HOST\\\":\\\"shop.tiktokw.us\\\",\\\"RPC_PERSIST_BYTETIM_REQUEST_PATH\\\":\\\"/api/.*/streamer_desktop/live/promotion/create\\\",\\\"RPC_PERSIST_BYTETIM_META_VERSION\\\":\\\".*\\\",\\\"RPC_PERSIST_BYTETIM_DEVICE_DTYPE\\\":\\\".*\\\",\\\"RPC_PERSIST_PSM\\\":\\\"oec.affiliate.streamer_api\\\",\\\"RPC_PERSIST_PATH\\\":\\\"/api/.*/streamer_desktop/live/promotion/create\\\",\\\"RPC_PERSIST_BYTETIM_META_SIGN_KEY_VERSION\\\":\\\".*\\\",\\\"RPC_PERSIST_BYTETIM_REGION_STORE_COUNTRY\\\":\\\"us\\\",\\\"RPC_TRANSIT_traceparent\\\":\\\".*\\\",\\\"RPC_PERSIST_LANE_P_REAL_IP\\\":.*,\\\"RPC_PERSIST_LANE_P_DID\\\":\\\".*\\\",\\\"RPC_PERSIST_BYTETIM_META_CREATE_TIME\\\":\\\".*\\\",\\\"RPC_PERSIST_BYTETIM_REQUEST_CLIENT_IP\\\":.*,\\\"RPC_TRANSIT_tracestate\\\":\\\"_sr=.*\\\",\\\"RPC_PERSIST_BYTETIM_SERVICE_PSM\\\":\\\"oec.affiliate.streamer_api\\\",\\\"RPC_PERSIST_BYTETIM_REQUEST_HOST\\\":\\\"shop.tiktok.com\\\",\\\"RPC_PERSIST_BYTETIM_META_SCHEMA_VERSION\\\":\\\".*\\\"}\"}}}]]}} resp={{resp={\"promotion_infos\":[],\"failed_info\":{\".*\":[{\"product_id\":0,\"failed_info\":{\"faile_reason\":.*,\"faile_msg\":\"This product is no longer available for the LIVE Flash sale. If you want to continue using this LIVE Flash sale, please contact our support team in the Help Center.\"}}]},\"base_resp\":{\"StatusMessage\":\"\",\"StatusCode\":0}}}} _compliance_source=footprint",
                                "highlight": false,
                                "display_key_in_string": true,
                                "is_empty": false
                            }
                        ]
                    }
                ],
                "need_permission": false,
                "truncated": false
            }
        ],
        "truncated": false,
        "tag_infos": [
            {
                "psm": "oec.live.promotion_core",
                "acl_result": "pass",
                "iam_result": "pass",
                "desensitize_result": "raw"
            }
        ],
        "is_snapshot": false,
        "data_source_uid": "12016048"
    }
}
```

只需要关注：data->items->value->kv_list->key=_msg 对应的value值。

## 架构要求

1. 模块化区分
2. 代码需注释
3. 函数方法需要完整的注释和用例
4. 后续会迭代其他功能。
