# byted-live-promotion mcp工具

## 前置信息

### mcp 相关信息

- 概念：https://modelcontextprotocol.io/docs/getting-started/intro
- 基于 python sdk：https://github.com/modelcontextprotocol/python-sdk
- 基于 python http 协议例子：
  
```python
"""Weather tools for MCP Streamable HTTP server using NWS API."""

import argparse
from typing import Any

import httpx
import uvicorn

from mcp.server.fastmcp import FastMCP


# Initialize FastMCP server for Weather tools.
# If json_response is set to True, the server will use JSON responses instead of SSE streams
# If stateless_http is set to True, the server uses true stateless mode (new transport per request)
mcp = FastMCP(name="weather", json_response=False, stateless_http=False)

# Constants
NWS_API_BASE = "https://api.weather.gov"
USER_AGENT = "weather-app/1.0"


async def make_nws_request(url: str) -> dict[str, Any] | None:
    """Make a request to the NWS API with proper error handling."""
    headers = {"User-Agent": USER_AGENT, "Accept": "application/geo+json"}
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(url, headers=headers, timeout=30.0)
            response.raise_for_status()
            return response.json()
        except Exception:
            return None


def format_alert(feature: dict) -> str:
    """Format an alert feature into a readable string."""
    props = feature["properties"]
    return f"""
Event: {props.get('event', 'Unknown')}
Area: {props.get('areaDesc', 'Unknown')}
Severity: {props.get('severity', 'Unknown')}
Description: {props.get('description', 'No description available')}
Instructions: {props.get('instruction', 'No specific instructions provided')}
"""


@mcp.tool()
async def get_alerts(state: str) -> str:
    """Get weather alerts for a US state.

    Args:
        state: Two-letter US state code (e.g. CA, NY)
    """
    url = f"{NWS_API_BASE}/alerts/active/area/{state}"
    data = await make_nws_request(url)

    if not data or "features" not in data:
        return "Unable to fetch alerts or no alerts found."

    if not data["features"]:
        return "No active alerts for this state."

    alerts = [format_alert(feature) for feature in data["features"]]
    return "\n---\n".join(alerts)


@mcp.tool()
async def get_forecast(latitude: float, longitude: float) -> str:
    """Get weather forecast for a location.

    Args:
        latitude: Latitude of the location
        longitude: Longitude of the location
    """
    # First get the forecast grid endpoint
    points_url = f"{NWS_API_BASE}/points/{latitude},{longitude}"
    points_data = await make_nws_request(points_url)

    if not points_data:
        return "Unable to fetch forecast data for this location."

    # Get the forecast URL from the points response
    forecast_url = points_data["properties"]["forecast"]
    forecast_data = await make_nws_request(forecast_url)

    if not forecast_data:
        return "Unable to fetch detailed forecast."

    # Format the periods into a readable forecast
    periods = forecast_data["properties"]["periods"]
    forecasts = []
    for period in periods[:5]:  # Only show next 5 periods
        forecast = f"""
{period['name']}:
Temperature: {period['temperature']}°{period['temperatureUnit']}
Wind: {period['windSpeed']} {period['windDirection']}
Forecast: {period['detailedForecast']}
"""
        forecasts.append(forecast)

    return "\n---\n".join(forecasts)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Run MCP Streamable HTTP based server")
    parser.add_argument("--port", type=int, default=8123, help="Localhost port to listen on")
    args = parser.parse_args()

    # Start the server with Streamable HTTP transport
    uvicorn.run(mcp.streamable_http_app, host="localhost", port=args.port)
```

### 获取 jwt 密钥接口

- url：https://cloud.bytedance.net/auth/api/v1/jwt
- headers：
  - "User-Agent"："Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/"
  - "Accept"："application/json, text/plain, */*"
  - "Accept-Language":"zh-CN,zh;q=0.9,en;q=0.8"
  - "Cookie": f"{cookie_key}={cookie_value}"
  - 其中，cookie_key = "CAS_SESSION", cookie_value 则有用户环境变量提供。
- 响应 headers['x-jwt-token']

## 功能诉求

### 获取 psm 信息

> psm 概念：在开发一个服务之前先要确定服务的名字，服务名统一使用PSM进行命名，PSM即为Product, Subsys, Module，如：toutiao.article.item，在这里可以把PSM理解成一个域名，访问对应的PSM就是访问对应的域名。

接口信息：

- url："https://ms-neptune.byted.org/api/neptune/ms/service/search"
- url："https://ms-neptune.tiktok-us.org/api/neptune/ms/service/search"
- header:
  - "x-jwt-token":"xxx"
- param:
  - keyword: "xxx"
  - search_type: "all"

返回信息

```json
{
    "error_code": 0,
    "error_type": "",
    "error_message": "",
    "data": [
        {
            "id": 0,
            "created_at": "0001-01-01T00:00:00Z",
            "updated_at": "0001-01-01T00:00:00Z",
            "psm": "oec.affiliate.monitor",
            "node_id": 9439321,
            "parent_id": 0,
            "type": "thrift",
            "language": "",
            "framework": "kitex",
            "service_chinese_name": "oec.affiliate.monitor",
            "description": "oec.affiliate.monitor",
            "owners": "wangzhonghua.97",
            "git_url": "",
            "idl": "",
            "idl_repo": "",
            "status": "",
            "created_by": "",
            "last_updated_by": "",
            "deployment_platform": "tce",
            "from_ms_data": 0,
            "level": "P2",
            "extend_property": "",
            "framework_version": "",
            "platform_types": {
                "tce": "thrift"
            },
            "path": "",
            "name": "",
            "node_name": "",
            "more": {
                "cost": "",
                "quota": "",
                "subscribed": false
            },
            "source": 0
        }
    ]
}
```

> 注意： 上述是两个请求连接，因为是两个不同区域， 但我希望是并发请求，看返回结果字段psm哪个存在且匹配keyword的值，则取哪个。 

### 获取i18n服务集群接口

> 一个 psm 服务对应集群，本接口是通过 psm 返回哪些集群

接口信息：

- url：https://cloud.tiktok-row.net/api/v1/explorer/explorer/v5/plane/clusters
- param
  - psm：xxx
  - test_plane：1
  - env：prod
- header：
  - "accept"："application/json, text/plain, */*"
  - "x-jwt-token"：xxx

返回结果：

```json
{
    "error_code": 0,
    "data": [
        {
            "psm": "oec.affiliate.monitor",
            "cluster": "default",
            "zone": "MVAALI",
            "zone_display_name": "US-East",
            "idc": "maliva",
            "online": true
        },
        {
            "psm": "oec.affiliate.monitor",
            "cluster": "default",
            "zone": "SGALI",
            "zone_display_name": "Singapore-Central",
            "idc": "my",
            "online": true
        },
        {
            "psm": "oec.affiliate.monitor",
            "cluster": "default",
            "zone": "SGALI",
            "zone_display_name": "Singapore-Central",
            "idc": "my2",
            "online": true
        }
    ]
}
```

### 获取i18n集群对应机器实例地址

> 该接口的入参可以通过服务获取集群的接口功能获取

- url：https://cloud.tiktok-row.net/api/v1/explorer/explorer/v5/addrs
- param：
  - psm：xx
  - env：prod
  - zone：xxx
  - idc：xxx
  - cluster：xxx
- headers
  - "accept": "application/json, text/plain, */*"
  - "x-jwt-token"：xxx

返回结果：

```json
{"error_code":0,"data":["[fdbd:dc61:2:151::195]:11503"]}
```

## 架构要求

1. 模块化区分
2. 代码需注释
3. 函数方法需要完整的注释和用例
4. 后续会迭代其他功能。