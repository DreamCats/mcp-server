# 诉求

## 诉求描述

根据 psm 名称、指定区域、时间范围、关键词过滤条件，查询符合条件的日志数据。

举个例子 us 区域的例子：

url：https://logservice-tx.tiktok-us.org/streamlog/platform/microservice/v2/query/log （us）
method：POST
header:

```json
headers = {
    "X-Jwt-Token": jwt_token,  # JWT 认证令牌
    "accept": "application/json, text/plain, */*",
    "Content-Type": "application/json",
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36 Edg/140.0.0.0"
}
```

body：

```json
{
  "data_source_uid": "",
  "context": [],
  "start": 1763609508,
  "end": 1763616708,
  "psm_list": ["ttec.script.live_promotion_change"],
  "keyword_filter": {
    "include": {
      "case_sensitive": true,
      "operator": "AND",
      "word_list": [
        {
          "word": "7574375222149809934",
          "is_term": false
        }
      ]
    },
    "exclude": {
      "words": [],
      "case_sensitive": true,
      "operator": "AND"
    }
  },
  "kv_filters": [
    {
      "key": "_idc",
      "type": "STRING",
      "operator": "is",
      "value": ["useast5"]
    }
  ],
  "enable_index": false,
  "limit": 100,
  "timeout_in_ms": 2000,
  "vregion": "US-TTP"
}
```

返回值：

```json
{
  "error_code": 0,
  "error_type": "",
  "error_message": "",
  "data": {
    "content": [
      {
        "context_id": "6655582917600404605",
        "messages": [
          {
            "key": "_level",
            "type": "STRING",
            "biz_type": "",
            "value": "Info",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "__logid",
            "type": "STRING",
            "biz_type": "LOGID",
            "value": "02176361656922500000000000000000000ffff0a6b21c6a77bd2",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_podname",
            "type": "STRING",
            "biz_type": "POD_NAME",
            "value": "dp-477b3048b9-84589dcb7c-mlwb8",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_msg",
            "type": "STRING",
            "biz_type": "",
            "value": "[PlatformPromotionStockChangeEventHandler] receive stock change event, msg={\"biz_type\":1,\"changes\":[{\"change_type\":2,\"stock_id\":7574375222149809934,\"stock_type\":10,\"current_stock\":2},{\"change_type\":3,\"stock_id\":7574375222149809934,\"stock_type\":3,\"current_stock\":0}],\"timestamp\":1763616569436} _compliance_nlp_log _compliance_source=footprint",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "current_version",
            "type": "STRING",
            "biz_type": "",
            "value": "75616508a75825f337c105be9931a89c",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "__timestamp",
            "type": "LONG",
            "biz_type": "DATE",
            "value": "1763616569597000",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_batchid",
            "type": "STRING",
            "biz_type": "",
            "value": "00f92d9c5bc64790bc480a2f2bea46ee0000000000000179",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_cluster",
            "type": "STRING",
            "biz_type": "",
            "value": "default",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_flags",
            "type": "INT",
            "biz_type": "",
            "value": "0",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_idc",
            "type": "STRING",
            "biz_type": "",
            "value": "useast5",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_ipv4",
            "type": "IPV4",
            "biz_type": "IPV4",
            "value": "9.24.152.66",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_ipv6",
            "type": "IPV6",
            "biz_type": "IPV6",
            "value": "0:0:0:0:0:0:0:0",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_language",
            "type": "STRING",
            "biz_type": "",
            "value": "go",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_location",
            "type": "STRING",
            "biz_type": "",
            "value": "/opt/tiger/compile_path/src/code.byted.org/ttec/live_promotion_change_script/handler/platform_promotion_stock_change.go:27",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_psm",
            "type": "STRING",
            "biz_type": "",
            "value": "ttec.script.live_promotion_change",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_spanid",
            "type": "UINT64",
            "biz_type": "",
            "value": "3709734892246337442",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_stage",
            "type": "STRING",
            "biz_type": "",
            "value": "canary",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          }
        ]
      },
      {
        "context_id": "17016084632750664934",
        "messages": [
          {
            "key": "_level",
            "type": "STRING",
            "biz_type": "",
            "value": "Info",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "__logid",
            "type": "STRING",
            "biz_type": "LOGID",
            "value": "202511200528567B2C0975C83A4D001585",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_podname",
            "type": "STRING",
            "biz_type": "POD_NAME",
            "value": "dp-ec1577101a-5465954689-qnqdr",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_msg",
            "type": "STRING",
            "biz_type": "",
            "value": "[PlatformPromotionStockChangeEventHandler] receive stock change event, msg={\"biz_type\":1,\"changes\":[{\"change_type\":2,\"stock_id\":7574375222149809934,\"stock_type\":3,\"current_stock\":1},{\"change_type\":3,\"stock_id\":7574375222149809934,\"stock_type\":10,\"current_stock\":1}],\"timestamp\":1763616537735} _compliance_nlp_log _compliance_source=footprint",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "current_version",
            "type": "STRING",
            "biz_type": "",
            "value": "75616508a75825f337c105be9931a89c",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "__timestamp",
            "type": "LONG",
            "biz_type": "DATE",
            "value": "1763616537892000",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_batchid",
            "type": "STRING",
            "biz_type": "",
            "value": "5270a2faddb3414781087114bee57edc00000000000023bb",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_cluster",
            "type": "STRING",
            "biz_type": "",
            "value": "default",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_flags",
            "type": "INT",
            "biz_type": "",
            "value": "0",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_idc",
            "type": "STRING",
            "biz_type": "",
            "value": "useast5",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_ipv4",
            "type": "IPV4",
            "biz_type": "IPV4",
            "value": "10.114.69.151",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_ipv6",
            "type": "IPV6",
            "biz_type": "IPV6",
            "value": "0:0:0:0:0:0:0:0",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_language",
            "type": "STRING",
            "biz_type": "",
            "value": "go",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_location",
            "type": "STRING",
            "biz_type": "",
            "value": "/opt/tiger/compile_path/src/code.byted.org/ttec/live_promotion_change_script/handler/platform_promotion_stock_change.go:27",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_psm",
            "type": "STRING",
            "biz_type": "",
            "value": "ttec.script.live_promotion_change",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_spanid",
            "type": "UINT64",
            "biz_type": "",
            "value": "7029682831895976951",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          },
          {
            "key": "_stage",
            "type": "STRING",
            "biz_type": "",
            "value": "canary",
            "highlight": false,
            "display_key_in_string": false,
            "is_empty": false
          }
        ]
      }
    ],
    "log_size": 1721,
    "finished": true,
    "context": [
      {
        "sub_request_key": "platform_store_snapshot",
        "cursor": "17040976",
        "finished": "platform_store_snapshot",
        "count": "1"
      },
      {
        "sub_request_key": "platform_query_cost",
        "finished": "true",
        "count": "5165288553"
      },
      {
        "sub_request_key": "platform_query_count",
        "count": "2"
      },
      {
        "sub_request_key": "platform_scan_size",
        "count": "711119712"
      },
      {
        "sub_request_key": "platform_query_type",
        "cursor": "streamlog"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763609508:1763611200_/structlog-6010663299854722564-2025112003/40470_2703232:3751808]]",
        "cursor": "6XKmCwAAAAAXjZEEAAAAAAAAOBAAAAAAlwY3AAAAAAAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763609508:1763611200_/structlog-6010663299854722564-2025112003/26006_199808:923136,40470_2377984:2703232]]",
        "cursor": "ht08CgAAAABjlWkBAAAAAOlypgsAAAAADJYoAAAAAQAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763611200:1763614800_/structlog-6010663299854722564-2025112004/13846_488576:1537152]]",
        "cursor": "xLArAgAAAACfLGIEAAAAAGPdjQYAAAAAjjsVAAAAAAAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763614800:1763616708_/structlog-6010663299854722564-2025112005/61334_1194240:2119040]]",
        "cursor": "6F4/BAAAAAAYoUADAAAAAAAAgAcAAAAAQIMeAAAAAAAAAAAA",
        "finished": "true",
        "count": "1",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763611200:1763614800_/structlog-6010663299854722564-2025112004/13846_2585728:3634304]]",
        "cursor": "k1bMCgAAAABddTsEAAAAAPDLBw8AAAAAnR01AAAAAAAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763614800:1763616708_/structlog-6010663299854722564-2025112005/52886_128:903168,61334_128:145664]]",
        "cursor": "AAAAAAAAAAA+Z7AAAAAAAD5nsAAAAAAADOoBAAAAAQAAAAAA",
        "finished": "true",
        "count": "1",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763614800:1763616708_/structlog-6010663299854722564-2025112005/61334_145664:1194240]]",
        "cursor": "PmewAAAAAACq944DAAAAAOhePwQAAAAAOFoQAAAAAAAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763611200:1763614800_/structlog-6010663299854722564-2025112004/13846_3634304:4174208,31638_128:43648]]",
        "cursor": "AAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAApUAAAAAAQAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763611200:1763614800_/structlog-6010663299854722564-2025112004/13846_1537152:2585728]]",
        "cursor": "Y92NBgAAAAAweT4EAAAAAJNWzAoAAAAAmDUlAAAAAAAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763611200:1763614800_/structlog-6010663299854722564-2025112004/8342_128:560256,13846_128:488576]]",
        "cursor": "AAAAAAAAAADEsCsCAAAAAMSwKwIAAAAAwpQGAAAAAQAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      },
      {
        "sub_request_key": "[[SK##_psm:ttec.script.live_promotion_change]][[LS##20]][[PT##bytelog]][[Z##useast5]][[PI##41]][[R##N]][[T##none]][[DATA_BLOCK_ID##20_1763609508:1763611200_/structlog-6010663299854722564-2025112003/40470_3751808:4494720]]",
        "cursor": "AAA4EAAAAAAAAOgCAAAAAAAAIBMAAAAAkHBDAAAAAAAAAAAA",
        "finished": "true",
        "count": "0",
        "log_source": "streamlog",
        "entry": "tx-ttp"
      }
    ],
    "download_url": "/streamlog/query/v3/download?format=%7B%22pattern%22:%22%5B_level%5D%20%5B__timestamp%5D%20%5B_location%5D%20%5B_ipv4%5D%20%5B_psm%5D%20%5B__logid%5D%20%5B_cluster%5D%20%5B_stage%5D%20%5B_idc%5D%20%5B_spanid%5D%20_podname=%5B_podname%5D%20_ipv6=%5B_ipv6%5D%20%5Bk=v:other%5D%20_msg=%5B_msg%5D%22%2C%22type%22:%22TEXT%22%7D&query_cmd=SELECT%20trim%28_msg%29%20AS%20_msg%2C%20microsFormat%28__timestamp%29%20AS%20__timestamp%2C%20%2A%20FROM%20default@argos%20WHERE%20_psm=%27ttec.script.live_promotion_change%27%20AND%20_idc=%27useast5%27%20AND%20%28__all_fields%20CONTAINS%28%277574375222149809934%27%29%29%20TIME%201763609508%2C1763616708&user_name=maifeng&user_type=person_account",
    "sampled_psm": [],
    "data_source_uid": "17040976",
    "is_snapshot": false,
    "total_scan_log_size": 711119712,
    "query_progress": 100
  }
}
```
